/*
	Kailash Nadh (http://kailashnadh.name)

	localStorageDB
	September 2011
	A simple database layer for localStorage

	v 1.8 November 2012

	License	:	MIT License
*/
function localStorageDB(a,b){function h(){delete g[d],f=null}function i(){var a=0;for(var b in f.tables)f.tables.hasOwnProperty(b)&&a++;return a}function j(a){return f.tables[a]?!0:!1}function k(a){j(a)||y("The table '"+a+"' does not exist.")}function l(a,b){f.tables[a]={fields:b,auto_increment:1},f.data[a]={}}function m(a){delete f.tables[a],delete f.data[a]}function n(a){f.tables[a].auto_increment=1,f.data[a]={}}function o(a){var b=0;for(var c in f.data[a])f.data[a].hasOwnProperty(c)&&b++;return b}function p(a,b){return b.ID=f.tables[a].auto_increment,f.data[a][f.tables[a].auto_increment]=b,f.tables[a].auto_increment++,b.ID}function q(a,b){var c=null,d=[],e=null;for(var g=0;g<b.length;g++)c=b[g],e=f.data[a][c],d.push(z(e));return d}function r(a,b,c){var d=[],e=!1,g=null;for(var h in f.data[a]){if(!f.data[a].hasOwnProperty(h))continue;g=f.data[a][h],e=!1;for(var i in b){if(!b.hasOwnProperty(i))continue;if(typeof b[i]=="string"){if(g[i].toString().toLowerCase()==b[i].toString().toLowerCase()){e=!0;break}}else if(g[i]==b[i]){e=!0;break}}e&&d.push(h);if(d.length==c)break}return d}function s(a,b,c){var d=[],e=!1,g=null;for(var h in f.data[a]){if(!f.data[a].hasOwnProperty(h))continue;g=f.data[a][h],b(z(g))==1&&d.push(h);if(d.length==c)break}return d}function t(a,b){var c=[];for(var d in f.data[a])if(f.data[a].hasOwnProperty(d)){c.push(d);if(c.length==b)break}return c}function u(a,b){for(var c=0;c<b.length;c++)f.data[a].hasOwnProperty(b[c])&&delete f.data[a][b[c]];return b.length}function v(a,b,c){var d="",e=0;for(var g=0;g<b.length;g++){d=b[g];var h=c(z(f.data[a][d]));if(h){delete h.ID;var i=f.data[a][d];for(var j in h)h.hasOwnProperty(j)&&(i[j]=h[j]);f.data[a][d]=B(a,i),e++}}return e}function w(){g[d]=JSON.stringify(f)}function x(){return JSON.stringify(f)}function y(a){throw new Error(a)}function z(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function A(a){return a.match(/[^a-z_0-9]/ig)?!1:!0}function B(a,b){var c="",d={};for(var e=0;e<f.tables[a].fields.length;e++)c=f.tables[a].fields[e],b[c]&&(d[c]=b[c]);return d}function C(a,b){var c="",d={};for(var e=0;e<f.tables[a].fields.length;e++)c=f.tables[a].fields[e],d[c]=b[c]?b[c]:null;return d}var c="db_",d=c+a,e=!1,f=null,g=b?b:localStorage;return f=g[d],f&&(f=JSON.parse(f))&&f.tables&&f.data||(A(a)?(f={tables:{},data:{}},w(),e=!0):y("The name '"+a+"'"+" contains invalid characters.")),{commit:function(){w()},isNew:function(){return e},drop:function(){h()},serialize:function(){return x()},tableExists:function(a){return j(a)},tableCount:function(){return i()},createTable:function(a,b){var c=!1;if(!A(a))y("The database name '"+a+"'"+" contains invalid characters.");else if(this.tableExists(a))y("The table name '"+a+"' already exists.");else{var d=!0;for(var e=0;e<b.length;e++)if(!A(b[e])){d=!1;break}if(d){var f={};for(var e=0;e<b.length;e++)f[b[e]]=!0;delete f.ID,b=["ID"];for(var g in f)f.hasOwnProperty(g)&&b.push(g);l(a,b),c=!0}else y("One or more field names in the table definition contains invalid characters.")}return c},dropTable:function(a){k(a),m(a)},truncate:function(a){k(a),n(a)},rowCount:function(a){return k(a),o(a)},insert:function(a,b){return k(a),p(a,C(a,b))},insertOrUpdate:function(a,b,c){k(a);var d=[];c?typeof c=="object"?d=r(a,B(a,c)):typeof c=="function"&&(d=s(a,c)):d=t(a);if(d.length==0)return p(a,C(a,b));var e=[];for(var f=0;f<d.length;f++)v(a,d,function(a){return e.push(a.ID),b});return e},update:function(a,b,c){k(a);var d=[];return b?typeof b=="object"?d=r(a,B(a,b)):typeof b=="function"&&(d=s(a,b)):d=t(a),v(a,d,c)},query:function(a,b,c){k(a);var d=[];return b?typeof b=="object"?d=r(a,B(a,b),c):typeof b=="function"&&(d=s(a,b,c)):d=t(a,c),q(a,d,c)},deleteRows:function(a,b){k(a);var c=[];return b?typeof b=="object"?c=r(a,B(a,b)):typeof b=="function"&&(c=s(a,b)):c=t(a),u(a,c)}}}