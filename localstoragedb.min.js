/*
	Kailash Nadh (http://nadh.in)

	localStorageDB
	September 2011
	A simple database layer for localStorage

	v 1.9 Nov 2012
	v 2.0 June 2013
	v 2.1 Nov 2013
	v 2.2 Jan 2014 Contribution: Andy Hawkins (http://a904guy.com) 
	v 2.3 Feb 2014 Contribution: Christian Kellner (http://orange-coding.net)

	License	:	MIT License
*/
!function(v,z){function p(w,p){function l(a){e.tables[a]||h("The table '"+a+"' does not exist")}function A(a,b,c){e.tables[a].fields=e.tables[a].fields.concat(b);if("undefined"!=typeof c)for(var d in e.data[a])if(e.data[a].hasOwnProperty(d))for(var f in b)e.data[a][d][b[f]]="object"==typeof c?c[b[f]]:c}function x(a,b){b.ID=e.tables[a].auto_increment;e.data[a][e.tables[a].auto_increment]=b;e.tables[a].auto_increment++;return b.ID}function v(a,b){return function(c,d){return"DESC"===b?c[a]<d[a]:c[a]> d[a]}}function q(a,b){var c=[],d=!1,f=null,g;for(g in e.data[a])if(e.data[a].hasOwnProperty(g)){var f=e.data[a][g],d=!0,k;for(k in b)if(b.hasOwnProperty(k))if("string"==typeof b[k]){if(f[k].toString().toLowerCase()!=b[k].toString().toLowerCase()){d=!1;break}}else if(f[k]!=b[k]){d=!1;break}d&&c.push(g)}return c}function r(a,b){var c=[],d=null,f;for(f in e.data[a])e.data[a].hasOwnProperty(f)&&(d=e.data[a][f],!0==b(y(d))&&c.push(f));return c}function s(a){var b=[],c;for(c in e.data[a])e.data[a].hasOwnProperty(c)&& b.push(c);return b}function B(a,b,c){for(var d="",f=0,g=0;g<b.length;g++){var d=b[g],k=c(y(e.data[a][d]));if(k){delete k.ID;var C=e.data[a][d],h;for(h in k)k.hasOwnProperty(h)&&(C[h]=k[h]);e.data[a][d]=n(a,C);f++}}return f}function D(){try{return t.setItem(u,JSON.stringify(e)),!0}catch(a){return!1}}function h(a){throw Error(a);}function y(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function m(a){return a.toString().match(/[^a-z_0-9]/ig)?!1:!0}function n(a,b){for(var c="",d= {},f=0;f<e.tables[a].fields.length;f++)c=e.tables[a].fields[f],b[c]!==z&&(d[c]=b[c]);return d}function E(a,b){for(var c="",d={},f=0;f<e.tables[a].fields.length;f++)c=e.tables[a].fields[f],d[c]=null===b[c]||b[c]===z?null:b[c];return d}var u="db_"+w,F=!1,e=null,t=p==sessionStorage?sessionStorage:localStorage,e=t[u];e&&(e=JSON.parse(e))&&e.tables&&e.data||(m(w)?(e={tables:{},data:{}},D(),F=!0):h("The name '"+w+"' contains invalid characters"));return{commit:function(){return D()},isNew:function(){return F}, drop:function(){t[u]&&(delete t[u],e=null)},serialize:function(){return JSON.stringify(e)},tableExists:function(a){return e.tables[a]?!0:!1},tableFields:function(a){return e.tables[a].fields},tableCount:function(){var a=0,b;for(b in e.tables)e.tables.hasOwnProperty(b)&&a++;return a},columnExists:function(a,b){var c=!1,d=e.tables[a].fields,f;for(f in d)if(d[f]==b){c=!0;break}return c},createTable:function(a,b){var c=!1;if(m(a))if(this.tableExists(a))h("The table name '"+a+"' already exists.");else{for(var d= !0,f=0;f<b.length;f++)if(!m(b[f])){d=!1;break}if(d){c={};for(f=0;f<b.length;f++)c[b[f]]=!0;delete c.ID;b=["ID"];for(var g in c)c.hasOwnProperty(g)&&b.push(g);e.tables[a]={fields:b,auto_increment:1};e.data[a]={};c=!0}else h("One or more field names in the table definition contains invalid characters")}else h("The database name '"+a+"' contains invalid characters.");return c},createTableWithData:function(a,b){("object"!==typeof b||!b.length||1>b.length)&&h("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]"); var c=Object.keys(b[0]);if(this.createTable(a,c)){this.commit();for(c=0;c<b.length;c++)x(a,b[c])||h("Failed to insert record: ["+JSON.stringify(b[c])+"]");this.commit()}return!0},dropTable:function(a){l(a);delete e.tables[a];delete e.data[a]},truncate:function(a){l(a);e.tables[a].auto_increment=1;e.data[a]={}},alterTable:function(a,b,c){var d=!1;if(m(a))if("object"==typeof b){for(var e=!0,g=0;g<b.length;g++)if(!m(b[g])){e=!1;break}if(e){d={};for(g=0;g<b.length;g++)d[b[g]]=!0;delete d.ID;b=[];for(var k in d)d.hasOwnProperty(k)&& b.push(k);A(a,b,c);d=!0}else h("One or more field names in the table definition contains invalid characters")}else"string"==typeof b&&(m(b)?(g=[],g.push(b),A(a,g,c),d=!0):h("One or more field names in the table definition contains invalid characters"));else h("The database name '"+a+"' contains invalid characters");return d},rowCount:function(a){l(a);var b=0,c;for(c in e.data[a])e.data[a].hasOwnProperty(c)&&b++;return b},insert:function(a,b){l(a);return x(a,E(a,b))},insertOrUpdate:function(a,b,c){l(a); var d=[];b?"object"==typeof b?d=q(a,n(a,b)):"function"==typeof b&&(d=r(a,b)):d=s(a);if(0==d.length)return x(a,E(a,c));var e=[];for(b=0;b<d.length;b++)B(a,d,function(a){e.push(a.ID);return c});return e},update:function(a,b,c){l(a);var d=[];b?"object"==typeof b?d=q(a,n(a,b)):"function"==typeof b&&(d=r(a,b)):d=s(a);return B(a,d,c)},query:function(a,b,c,d,f){l(a);var g=[];b?"object"==typeof b?g=q(a,n(a,b),c,d):"function"==typeof b&&(g=r(a,b,c,d)):g=s(a,c,d);b=g;for(var k=null,g=[],k=null,h=0;h<b.length;h++)k= b[h],k=e.data[a][k],g.push(y(k));if(f&&f instanceof Array)for(h=0;h<f.length;h++)g.sort(v(f[h][0],1<f[h].length?f[h][1]:null));d=d&&"number"===typeof d?d:null;c=c&&"number"===typeof c?c:null;d&&c?g=g.slice(d,d+c):d?g=g.slice(d):c&&(g=g.slice(d,c));return g},queryAll:function(a,b){return this.query(a,b.hasOwnProperty("query")?b.query:null,b.hasOwnProperty("limit")?b.limit:null,b.hasOwnProperty("start")?b.start:null,b.hasOwnProperty("sort")?b.sort:null)},deleteRows:function(a,b){l(a);var c=[];b?"object"== typeof b?c=q(a,n(a,b)):"function"==typeof b&&(c=r(a,b)):c=s(a);for(var d=0;d<c.length;d++)e.data[a].hasOwnProperty(c[d])&&delete e.data[a][c[d]];return c.length}}}"function"===typeof define&&define.amd?define(function(){return p}):v.localStorageDB=p}(window);
