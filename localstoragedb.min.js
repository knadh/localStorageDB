/*
	Kailash Nadh (http://nadh.in)
	
	localStorageDB
	September 2011
	A simple database layer for localStorage

	v 1.9 November 2012
	v 2.0 June 2013
	v 2.1 Nov 2013
	v 2.2 Jan 2014 Contribution: Andy Hawkins (http://a904guy.com) 
	v 2.3 Feb 2014 Contribution: Christian Kellner (http://orange-coding.net)	

	License	:	MIT License
*/

!function(u,B){function t(v,t){function h(a){d.tables[a]||g("The table '"+a+"' does not exist.")}function C(a,b,c){d.tables[a].fields=d.tables[a].fields.concat(b);if("undefined"!=typeof c)for(var e in d.data[a])if(d.data[a].hasOwnProperty(e))for(var f in b)d.data[a][e][b[f]]="object"==typeof c?c[b[f]]:c}function w(a,b){b.ID=d.tables[a].auto_increment;d.data[a][d.tables[a].auto_increment]=b;d.tables[a].auto_increment++;return b.ID}function D(a,b){for(var c=null,e=[],c=null,f=0;f<b.length;f++)c=b[f], c=d.data[a][c],e.push(x(c));return e}function u(a,b){var c=y.values(d.data[a]),e=b.mode,f=b.field;c.sort(function(a,b){var c="";switch(e){case 0:c=a[f]<b[f];break;case 1:c=a[f]>b[f]}return c});return c}function q(a,b,c,e){var f=[],d=!1,k=null,g=0,l;for(l in a){var h=a[l].ID,k=a[l],d=!0,m;for(m in b)if(b.hasOwnProperty(m))if("string"==typeof b[m]){if(k[m].toString().toLowerCase()!=b[m].toString().toLowerCase()){d=!1;break}}else if(k[m]!=b[m]){d=!1;break}if(d){if("number"===typeof e&&g<e){g++;continue}f.push(h)}if(f.length== c)break}return f}function r(a,b,c,e){var f=[],d=null,k=0,g;for(g in a){var h=a[g].ID,d=a[g];if(!0==b(x(d))){if("number"===typeof e&&k<e){k++;continue}f.push(h)}if(f.length==c)break}return f}function s(a,b,c){var e=[],f=0,d;for(d in a){var g=a[d].ID;if("number"===typeof c&&f<c)f++;else if(e.push(g),e.length==b)break}return e}function E(a,b,c){for(var e="",f=0,g=0;g<b.length;g++){var e=b[g],k=c(x(d.data[a][e]));if(k){delete k.ID;var h=d.data[a][e],l;for(l in k)k.hasOwnProperty(l)&&(h[l]=k[l]);d.data[a][e]= n(a,h);f++}}return f}function F(){try{return z[A]=JSON.stringify(d),!0}catch(a){return!1}}function g(a){throw Error(a);}function x(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function p(a){return a.toString().match(/[^a-z_0-9]/ig)?!1:!0}function n(a,b){for(var c="",e={},f=0;f<d.tables[a].fields.length;f++)c=d.tables[a].fields[f],null!==b[c]&&b[c]!==B&&(e[c]=b[c]);return e}function G(a,b){for(var c="",e={},f=0;f<d.tables[a].fields.length;f++)c=d.tables[a].fields[f],e[c]=null=== b[c]||b[c]===B?null:b[c];return e}var y={values:function(a){var b=[],c;for(c in a)b.push(a[c]);return b}},A="db_"+v,H=!1,d=null,z=t==sessionStorage?sessionStorage:localStorage,d=z[A];d&&(d=JSON.parse(d))&&d.tables&&d.data||(p(v)?(d={tables:{},data:{}},F(),H=!0):g("The name '"+v+"' contains invalid characters."));return{commit:function(){return F()},isNew:function(){return H},drop:function(){delete z[A];d=null},serialize:function(){return JSON.stringify(d)},tableExists:function(a){return d.tables[a]? !0:!1},tableFields:function(a){return d.tables[a].fields},tableCount:function(){var a=0,b;for(b in d.tables)d.tables.hasOwnProperty(b)&&a++;return a},columnExists:function(a,b){var c=!1,e=d.tables[a].fields,f;for(f in e)if(e[f]==b){c=!0;break}return c},createTable:function(a,b){var c=!1;if(p(a))if(this.tableExists(a))g("The table name '"+a+"' already exists.");else{for(var e=!0,f=0;f<b.length;f++)if(!p(b[f])){e=!1;break}if(e){c={};for(f=0;f<b.length;f++)c[b[f]]=!0;delete c.ID;b=["ID"];for(var h in c)c.hasOwnProperty(h)&& b.push(h);d.tables[a]={fields:b,auto_increment:1};d.data[a]={};c=!0}else g("One or more field names in the table definition contains invalid characters.")}else g("The database name '"+a+"' contains invalid characters.");return c},createTableWithData:function(a,b){("object"!==typeof b||!b.length||1>b.length)&&g("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]");var c=Object.keys(b[0]);if(this.createTable(a,c)){this.commit();for(c=0;c<b.length;c++)w(a,b[c])||g("Failed to insert record: ["+ JSON.stringify(b[c])+"]");this.commit()}return!0},dropTable:function(a){h(a);delete d.tables[a];delete d.data[a]},truncate:function(a){h(a);d.tables[a].auto_increment=1;d.data[a]={}},alterTable:function(a,b,c){var e=!1;if(p(a))if("object"==typeof b){for(var f=!0,d=0;d<b.length;d++)if(!p(b[d])){f=!1;break}if(f){e={};for(d=0;d<b.length;d++)e[b[d]]=!0;delete e.ID;b=[];for(var h in e)e.hasOwnProperty(h)&&b.push(h);C(a,b,c);e=!0}else g("One or more field names in the table definition contains invalid characters.")}else"string"== typeof b&&(p(b)?(d=[],d.push(b),C(a,d,c),e=!0):g("One or more field names in the table definition contains invalid characters."));else g("The database name '"+a+"' contains invalid characters.");return e},rowCount:function(a){h(a);var b=0,c;for(c in d.data[a])d.data[a].hasOwnProperty(c)&&b++;return b},insert:function(a,b){h(a);return w(a,G(a,b))},insertOrUpdate:function(a,b,c){h(a);var e=[];b?"object"==typeof b?e=q(a,n(a,b)):"function"==typeof b&&(e=r(a,b)):e=s(a);if(0==e.length)return w(a,G(a,c)); var d=[];for(b=0;b<e.length;b++)E(a,e,function(a){d.push(a.ID);return c});return d},update:function(a,b,c){h(a);var e=[];b?"object"==typeof b?e=q(a,n(a,b)):"function"==typeof b&&(e=r(a,b)):e=s(a);return E(a,e,c)},query:function(a,b,c,e){h(a);var f=y.values(d.data[a]);b?"object"==typeof b?result_ids=q(f,n(a,b),c,e):"function"==typeof b&&(result_ids=r(f,b,c,e)):result_ids=s(f,c,e);return D(a,result_ids,c)},sortedQuery:function(a,b,c,e,d){h(a);c=u(a,c);b?"object"==typeof b?result_ids=q(c,n(a,b),e,d): "function"==typeof b&&(result_ids=r(c,b,e,d)):result_ids=s(c,e,d);return D(a,result_ids,e)},deleteRows:function(a,b){h(a);var c=y.values(d.data[a]),e=[];b?"object"==typeof b?e=q(c,n(a,b)):"function"==typeof b&&(e=r(c,b)):e=s(c);c=e;for(e=0;e<c.length;e++)d.data[a].hasOwnProperty(c[e])&&delete d.data[a][c[e]];return c.length}}}"function"===typeof define&&define.amd?define(function(){return t}):u.localStorageDB=t}(window);