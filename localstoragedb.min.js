/*
	Kailash Nadh (http://nadh.in)
	
	localStorageDB
	September 2011
	A simple database layer for localStorage

	v 1.9 November 2012
	v 2.0 June 2013
	v 2.1 Nov 2013
	v 2.2 Jan 2014 Contribution: Andy Hawkins (http://a904guy.com) 
	v 2.3 Feb 2014 Contribution: Christian Kellner (http://orange-coding.net)	

	License	:	MIT License
*/

!function(v,B){function u(w,u){function k(a){d.tables[a]||h("The table '"+a+"' does not exist.")}function C(a,b,c){d.tables[a].fields=d.tables[a].fields.concat(b);if("undefined"!=typeof c)for(var e in d.data[a])if(d.data[a].hasOwnProperty(e))for(var f in b)d.data[a][e][b[f]]="object"==typeof c?c[b[f]]:c}function x(a,b){b.ID=d.tables[a].auto_increment;d.data[a][d.tables[a].auto_increment]=b;d.tables[a].auto_increment++;return b.ID}function D(a,b){for(var c=null,e=[],c=null,f=0;f<b.length;f++)c=b[f], c=d.data[a][c],e.push(y(c));return e}function v(a,b){var c=I.values(d.data[a]),e=b.mode,f=b.field;c.sort(function(a,b){var c="";switch(e.toLowerCase()){case "desc":c=a[f]<b[f];break;case "asc":c=a[f]>b[f]}return c});return c}function r(a,b,c,e){var f=[],d=!1,n=null,h=0,l;for(l in a)if(a.hasOwnProperty(l)){var k=a[l].ID,n=a[l],d=!0,m;for(m in b)if(b.hasOwnProperty(m))if("string"==typeof b[m]){if(n[m].toString().toLowerCase()!=b[m].toString().toLowerCase()){d=!1;break}}else if(n[m]!=b[m]){d=!1;break}if(d){if("number"=== typeof e&&h<e){h++;continue}f.push(k)}if(f.length==c)break}return f}function s(a,b,c,e){var d=[],g=null,n=0,h;for(h in a)if(a.hasOwnProperty(h)){var k=a[h].ID,g=a[h];if(!0==b(y(g))){if("number"===typeof e&&n<e){n++;continue}d.push(k)}if(d.length==c)break}return d}function t(a,b,c){var e=[],d=0,g;for(g in a)if(a.hasOwnProperty(g)){var h=a[g].ID;if("number"===typeof c&&d<c)d++;else if(e.push(h),e.length==b)break}return e}function E(a,b,c){for(var e="",f=0,g=0;g<b.length;g++){var e=b[g],h=c(y(d.data[a][e])); if(h){delete h.ID;var k=d.data[a][e],l;for(l in h)h.hasOwnProperty(l)&&(k[l]=h[l]);d.data[a][e]=p(a,k);f++}}return f}function F(){try{return z[A]=JSON.stringify(d),!0}catch(a){return!1}}function h(a){throw Error(a);}function y(a){var b={},c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function q(a){return a.toString().match(/[^a-z_0-9]/ig)?!1:!0}function p(a,b){for(var c="",e={},f=0;f<d.tables[a].fields.length;f++)c=d.tables[a].fields[f],null!==b[c]&&b[c]!==B&&(e[c]=b[c]);return e}function G(a, b){for(var c="",e={},f=0;f<d.tables[a].fields.length;f++)c=d.tables[a].fields[f],e[c]=null===b[c]||b[c]===B?null:b[c];return e}var I={values:function(a){var b=[],c;for(c in a)b.push(a[c]);return b},isArray:function(a){try{return a instanceof Array}catch(b){return!1}}},A="db_"+w,H=!1,d=null,z=u==sessionStorage?sessionStorage:localStorage,d=z[A];d&&(d=JSON.parse(d))&&d.tables&&d.data||(q(w)?(d={tables:{},data:{}},F(),H=!0):h("The name '"+w+"' contains invalid characters."));return{commit:function(){return F()}, isNew:function(){return H},drop:function(){delete z[A];d=null},serialize:function(){return JSON.stringify(d)},tableExists:function(a){return d.tables[a]?!0:!1},tableFields:function(a){return d.tables[a].fields},tableCount:function(){var a=0,b;for(b in d.tables)d.tables.hasOwnProperty(b)&&a++;return a},columnExists:function(a,b){var c=!1,e=d.tables[a].fields,f;for(f in e)if(e[f]==b){c=!0;break}return c},createTable:function(a,b){var c=!1;if(q(a))if(this.tableExists(a))h("The table name '"+a+"' already exists."); else{for(var e=!0,f=0;f<b.length;f++)if(!q(b[f])){e=!1;break}if(e){c={};for(f=0;f<b.length;f++)c[b[f]]=!0;delete c.ID;b=["ID"];for(var g in c)c.hasOwnProperty(g)&&b.push(g);d.tables[a]={fields:b,auto_increment:1};d.data[a]={};c=!0}else h("One or more field names in the table definition contains invalid characters.")}else h("The database name '"+a+"' contains invalid characters.");return c},createTableWithData:function(a,b){("object"!==typeof b||!b.length||1>b.length)&&h("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]"); var c=Object.keys(b[0]);if(this.createTable(a,c)){this.commit();for(c=0;c<b.length;c++)x(a,b[c])||h("Failed to insert record: ["+JSON.stringify(b[c])+"]");this.commit()}return!0},dropTable:function(a){k(a);delete d.tables[a];delete d.data[a]},truncate:function(a){k(a);d.tables[a].auto_increment=1;d.data[a]={}},alterTable:function(a,b,c){var d=!1;if(q(a))if("object"==typeof b){for(var f=!0,g=0;g<b.length;g++)if(!q(b[g])){f=!1;break}if(f){d={};for(g=0;g<b.length;g++)d[b[g]]=!0;delete d.ID;b=[];for(var k in d)d.hasOwnProperty(k)&& b.push(k);C(a,b,c);d=!0}else h("One or more field names in the table definition contains invalid characters.")}else"string"==typeof b&&(q(b)?(g=[],g.push(b),C(a,g,c),d=!0):h("One or more field names in the table definition contains invalid characters."));else h("The database name '"+a+"' contains invalid characters.");return d},rowCount:function(a){k(a);var b=0,c;for(c in d.data[a])d.data[a].hasOwnProperty(c)&&b++;return b},insert:function(a,b){k(a);return x(a,G(a,b))},insertOrUpdate:function(a,b, c){k(a);var e=[];b?"object"==typeof b?e=r(d.data[a],p(a,b)):"function"==typeof b&&(e=s(d.data[a],b)):e=t(d.data[a]);if(0==e.length)return x(a,G(a,c));var f=[];for(b=0;b<e.length;b++)E(a,e,function(a){f.push(a.ID);return c});return f},update:function(a,b,c){k(a);var e=[];b?"object"==typeof b?e=r(d.data[a],p(a,b)):"function"==typeof b&&(e=s(d.data[a],b)):e=t(d.data[a]);return E(a,e,c)},query:function(a,b,c,e){k(a);var f=[];b?"object"==typeof b?f=r(d.data[a],p(a,b),c,e):"function"==typeof b&&(f=s(d.data[a], b,c,e)):f=t(d.data[a],c,e);return D(a,f)},sortedQuery:function(a,b,c,d,f){k(a);c=v(a,c);var g=[];b?"object"==typeof b?g=r(c,p(a,b),d,f):"function"==typeof b&&(g=s(c,b,d,f)):g=t(c,d,f);return D(a,g)},deleteRows:function(a,b){k(a);var c=[];b?"object"==typeof b?c=r(d.data[a],p(a,b)):"function"==typeof b&&(c=s(d.data[a],b)):c=t(d.data[a]);for(var e=0;e<c.length;e++)d.data[a].hasOwnProperty(c[e])&&delete d.data[a][c[e]];return c.length}}}"function"===typeof define&&define.amd?define(function(){return u}): v.localStorageDB=u}(window);